#!/bin/bash

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Element
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: ./setup-duxigo.sh

set -e

echo "=========================================="
echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Element"
echo "=========================================="
echo ""

# Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð¾Ð¼ÐµÐ½Ð° Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
echo "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸:"
echo ""

read -p "Ð”Ð¾Ð¼ÐµÐ½ Ð´Ð»Ñ Element Web (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: test.duxigo.org): " DOMAIN
while [ -z "$DOMAIN" ]; do
    echo "Ð”Ð¾Ð¼ÐµÐ½ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
    read -p "Ð”Ð¾Ð¼ÐµÐ½ Ð´Ð»Ñ Element Web (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: test.duxigo.org): " DOMAIN
done

DEFAULT_CALL_DOMAIN="call.$DOMAIN"
read -p "Ð”Ð¾Ð¼ÐµÐ½ Ð´Ð»Ñ Element Call [$DEFAULT_CALL_DOMAIN]: " CALL_DOMAIN
if [ -z "$CALL_DOMAIN" ]; then
    CALL_DOMAIN="$DEFAULT_CALL_DOMAIN"
fi

echo ""
echo "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Synapse ÑÐµÑ€Ð²ÐµÑ€Ð°:"
read -p "URL Synapse ÑÐµÑ€Ð²ÐµÑ€Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: https://synapse.test.duxigo.org): " SYNAPSE_BASE_URL
while [ -z "$SYNAPSE_BASE_URL" ]; do
    echo "URL Synapse Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
    read -p "URL Synapse ÑÐµÑ€Ð²ÐµÑ€Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: https://synapse.test.duxigo.org): " SYNAPSE_BASE_URL
done

# ÐŸÐ°Ñ€ÑÐ¸Ð¼ Ð´Ð¾Ð¼ÐµÐ½ Ð¸Ð· URL Ð´Ð»Ñ SYNAPSE_HOST
SYNAPSE_DOMAIN=$(echo "$SYNAPSE_BASE_URL" | sed -e 's|^[^/]*//||' -e 's|/.*$||')

read -p "Ð˜Ð¼Ñ ÑÐµÑ€Ð²ÐµÑ€Ð° Synapse [$DOMAIN]: " SYNAPSE_SERVER_NAME
if [ -z "$SYNAPSE_SERVER_NAME" ]; then
    SYNAPSE_SERVER_NAME="$DOMAIN"
fi

echo ""
echo "ÐžÐ¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼Ð¸):"
read -p "TURN ÑÐµÑ€Ð²ÐµÑ€ - Ð¸Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: " TURN_USERNAME
read -sp "TURN ÑÐµÑ€Ð²ÐµÑ€ - Ð¿Ð°Ñ€Ð¾Ð»ÑŒ: " TURN_PASSWORD
echo ""
read -p "MapTiler API Key (Ð´Ð»Ñ ÐºÐ°Ñ€Ñ‚): " MAPTILER_KEY

echo ""
echo "=========================================="
echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Element Ð´Ð»Ñ $DOMAIN"
echo "=========================================="

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    sudo usermod -aG docker $USER
    rm get-docker.sh
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "âŒ Docker Compose Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
    sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
if [ ! -f .env ]; then
    echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°..."
    cat > .env << EOF
# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ ${DOMAIN}
SYNAPSE_BASE_URL=${SYNAPSE_BASE_URL}
SYNAPSE_SERVER_NAME=${SYNAPSE_SERVER_NAME}
SYNAPSE_HOST=${SYNAPSE_DOMAIN}

ELEMENT_WEB_DOMAIN=${DOMAIN}
ELEMENT_WEB_URL=https://${DOMAIN}

ELEMENT_CALL_BASE_URL=https://${CALL_DOMAIN}
ELEMENT_CALL_SERVER_NAME=element-call
ELEMENT_CALL_URL=https://${CALL_DOMAIN}

IDENTITY_SERVER_URL=https://vector.im

MATRIX_JS_SDK_VERSION=30.0.0
MATRIX_REACT_SDK_VERSION=3.90.0
ELEMENT_WEB_VERSION=1.11.0
ELEMENT_CALL_VERSION=0.5.0

TURN_SERVER_URL=turn:${CALL_DOMAIN}:3478
TURN_USERNAME=${TURN_USERNAME}
TURN_PASSWORD=${TURN_PASSWORD}
STUN_SERVER_URL=stun:${CALL_DOMAIN}:3478
EOF

    if [ -n "$MAPTILER_KEY" ]; then
        echo "MAPTILER_KEY=${MAPTILER_KEY}" >> .env
    fi

    echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼Ð¸"
else
    echo "âš ï¸  Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ"
fi

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
mkdir -p config certs nginx/conf.d builds

# ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ² (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
if [ ! -d "element-repos" ]; then
    echo "ðŸ“¦ ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ²..."
    chmod +x clone-repos.sh
    ./clone-repos.sh
fi

# Ð¤Ð¸ÐºÑÐ°Ñ†Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹ SDK
if [ -f "fix-sdk-versions.sh" ]; then
    echo "ðŸ”’ Ð¤Ð¸ÐºÑÐ°Ñ†Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¹ SDK..."
    chmod +x fix-sdk-versions.sh
    ./fix-sdk-versions.sh
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²..."
if [ ! -f "certs/fullchain.pem" ] || [ ! -f "certs/privkey.pem" ]; then
    echo "âš ï¸  SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð² certs/"
    echo ""
    echo "ðŸš€ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Docker..."
    echo ""
    
    # Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ email Ð´Ð»Ñ Let's Encrypt
    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ email Ð´Ð»Ñ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Let's Encrypt (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Enter Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ): " CERT_EMAIL
    
    echo ""
    echo "ðŸ“‹ Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ñ‹ ${DOMAIN} Ð¸ ${CALL_DOMAIN} ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð½Ð° ÑÑ‚Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€ (DNS)"
    echo ""
    read -p "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² ÑÐµÐ¹Ñ‡Ð°Ñ? (y/n): " GET_CERTS_NOW
    
    if [ "$GET_CERTS_NOW" = "y" ] || [ "$GET_CERTS_NOW" = "Y" ]; then
        echo ""
        echo "1ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ nginx Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ HTTP Ð´Ð»Ñ ACME challenge..."
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ nginx Ð´Ð»Ñ ACME challenge
        docker-compose up -d nginx 2>/dev/null || docker-compose up -d nginx
        
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° nginx
        echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° nginx..."
        sleep 5
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ certbot Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
        echo "2ï¸âƒ£ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ñ‡ÐµÑ€ÐµÐ· certbot..."
        
        CERTBOT_CMD="certbot certonly --webroot --webroot-path=/var/www/certbot --agree-tos --non-interactive"
        
        if [ -n "$CERT_EMAIL" ]; then
            CERTBOT_CMD="$CERTBOT_CMD --email $CERT_EMAIL"
        else
            CERTBOT_CMD="$CERTBOT_CMD --register-unsafely-without-email"
        fi
        
        CERTBOT_CMD="$CERTBOT_CMD -d $DOMAIN -d $CALL_DOMAIN"
        
        if docker-compose run --rm certbot $CERTBOT_CMD; then
            echo "âœ… Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹!"
            
            # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¸Ð· volume Ð² Ð¿Ð°Ð¿ÐºÑƒ certs/
            echo "3ï¸âƒ£ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð² Ð¿Ð°Ð¿ÐºÑƒ certs/..."
            
            # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð´Ð»Ñ ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
            docker-compose run --rm -v "$(pwd)/certs:/certs" certbot sh -c "
                cp /etc/letsencrypt/live/${DOMAIN}/fullchain.pem /certs/fullchain.pem && \
                cp /etc/letsencrypt/live/${DOMAIN}/privkey.pem /certs/privkey.pem && \
                chmod 644 /certs/fullchain.pem && \
                chmod 600 /certs/privkey.pem
            " || {
                # ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± - Ñ‡ÐµÑ€ÐµÐ· docker cp
                CERT_CONTAINER=$(docker-compose ps -q certbot 2>/dev/null || echo "")
                if [ -z "$CERT_CONTAINER" ]; then
                    CERT_CONTAINER=$(docker-compose run -d certbot sleep 60)
                    sleep 2
                fi
                
                docker cp ${CERT_CONTAINER}:/etc/letsencrypt/live/${DOMAIN}/fullchain.pem certs/fullchain.pem 2>/dev/null || true
                docker cp ${CERT_CONTAINER}:/etc/letsencrypt/live/${DOMAIN}/privkey.pem certs/privkey.pem 2>/dev/null || true
                
                if [ -n "$CERT_CONTAINER" ]; then
                    docker stop $CERT_CONTAINER 2>/dev/null || true
                    docker rm $CERT_CONTAINER 2>/dev/null || true
                fi
            }
            
            if [ -f "certs/fullchain.pem" ] && [ -f "certs/privkey.pem" ]; then
                echo "âœ… Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ Ð² certs/"
                
                # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ HTTPS
                echo "4ï¸âƒ£ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx Ð´Ð»Ñ HTTPS..."
                # ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ nginx - Ð¾Ð½Ð° ÑƒÐ¶Ðµ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ SSL, Ñ‚Ð°Ðº ÐºÐ°Ðº ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ ÐµÑÑ‚ÑŒ
                docker-compose restart nginx
                
                echo ""
                echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹."
                echo "ðŸŒ Ð’Ð°ÑˆÐ¸ ÑÐµÑ€Ð²Ð¸ÑÑ‹ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð¿Ð¾ HTTPS:"
                echo "   - https://${DOMAIN}"
                echo "   - https://${CALL_DOMAIN}"
                echo ""
                echo "ðŸ’¡ Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 12 Ñ‡Ð°ÑÐ¾Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð¼ certbot"
            else
                echo "âš ï¸  ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸"
                echo "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:"
                echo "  docker-compose exec certbot cp /etc/letsencrypt/live/${DOMAIN}/fullchain.pem /certs/"
                echo "  docker-compose exec certbot cp /etc/letsencrypt/live/${DOMAIN}/privkey.pem /certs/"
            fi
        else
            echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²"
            echo ""
            echo "Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹:"
            echo "  - Ð”Ð¾Ð¼ÐµÐ½Ñ‹ Ð½Ðµ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ð½Ð° ÑÑ‚Ð¾Ñ‚ ÑÐµÑ€Ð²ÐµÑ€ (Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ DNS)"
            echo "  - ÐŸÐ¾Ñ€Ñ‚Ñ‹ 80 Ð¸ 443 ÑƒÐ¶Ðµ Ð·Ð°Ð½ÑÑ‚Ñ‹"
            echo "  - Ð¡ÐµÑ€Ð²ÐµÑ€ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¸Ð· Ð¸Ð½Ñ‚ÐµÑ€Ð½ÐµÑ‚Ð°"
            echo ""
            echo "Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾Ð·Ð¶Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹:"
            echo "  docker-compose run --rm certbot certonly --webroot --webroot-path=/var/www/certbot -d ${DOMAIN} -d ${CALL_DOMAIN}"
        fi
    else
        echo ""
        echo "âš ï¸  ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾."
        echo "ÐŸÐ¾ÑÐ»Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ DNS Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ:"
        echo "  docker-compose up -d nginx"
        echo "  docker-compose run --rm certbot certonly --webroot --webroot-path=/var/www/certbot -d ${DOMAIN} -d ${CALL_DOMAIN}"
    fi
else
    echo "âœ… SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚"
fi

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx
echo "âš™ï¸  ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ nginx..."

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ ÐºÐ°ÐºÐ¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ
if [ -f "certs/fullchain.pem" ] && [ -f "certs/privkey.pem" ]; then
    # Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ HTTPS ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
    cat > nginx/conf.d/element.conf << EOF
# ACME Challenge Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
server {
    listen 80;
    server_name ${DOMAIN} ${CALL_DOMAIN};

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://\$host\$request_uri;
    }
}

# Element Web - HTTPS
server {
    listen 443 ssl http2;
    server_name ${DOMAIN};

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://element-web:80;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}

# Element Call - HTTPS
server {
    listen 443 ssl http2;
    server_name ${CALL_DOMAIN};

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://element-call:3000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF
else
    # Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð½ÐµÑ‚ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ HTTP ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ ACME challenge
    cat > nginx/conf.d/element.conf << EOF
# Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
# ACME Challenge
server {
    listen 80;
    server_name ${DOMAIN} ${CALL_DOMAIN};

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Element Web
    location / {
        if (\$host = ${DOMAIN}) {
            proxy_pass http://element-web:80;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto \$scheme;
        }
    }

    # Element Call
    location / {
        if (\$host = ${CALL_DOMAIN}) {
            proxy_pass http://element-call:3000;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto \$scheme;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade \$http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
EOF
fi

echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°"

# Ð”ÐµÐ¿Ð»Ð¾Ð¹
echo ""
echo "ðŸš€ Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº Ð´ÐµÐ¿Ð»Ð¾ÑŽ!"
echo ""
echo "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð´ÐµÐ¿Ð»Ð¾Ð¹ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð¾Ð¹:"
echo "  ./deploy.sh docker"
echo ""
echo "Ð˜Ð»Ð¸ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:"
echo "  docker-compose up -d"
echo ""
echo "ðŸ“ ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ:"
echo "  - SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð±ÑƒÐ´ÑƒÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ðµ 12 Ñ‡Ð°ÑÐ¾Ð²"
echo "  - Ð”Ð»Ñ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ: ./renew-certificates.sh"
echo ""

